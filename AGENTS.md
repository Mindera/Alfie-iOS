# Alfie iOS - AI Agent Instructions

**Project**: Alfie iOS E-Commerce Application  
**Platform**: iOS 16+  
**Language**: Swift 5.9+  
**Architecture**: MVVM with Modular Swift Packages  
**Last Updated**: December 2024

This file provides context to AI coding assistants following the [AGENTS.md standard](https://agents.md/).  
For detailed implementation guidelines, see [`.github/copilot-instructions.md`](.github/copilot-instructions.md).

---

## Project Overview

Alfie is a native iOS e-commerce application built with SwiftUI. The app allows users to browse products, search, manage a wishlist, and shop with an intuitive mobile experience. Data is fetched from a GraphQL BFF (Backend-For-Frontend) API.

**Key Features**:
- Product browsing by category
- Search with suggestions
- Wishlist management
- Shopping bag
- Product details with variants
- User authentication

---

## Architecture

### MVVM Pattern

Every feature follows strict MVVM architecture:

```
Feature/
├── FeatureView.swift              # SwiftUI View
├── FeatureViewModel.swift         # Business logic, @Published state
└── FeatureDependencyContainer.swift  # Filtered dependencies
```

**State Management**:
- Use `ViewState<Value, Error>` for simple flows
- Use `PaginatedViewState<Value, Error>` for lists with pagination
- All state changes trigger UI updates via `@Published` properties

### Navigation

Custom navigation framework with:
- **Coordinator**: Handles all navigation logic (injected as `@EnvironmentObject`)
- **Screen**: Enum defining all possible destinations
- **ViewFactory**: Creates Views with their dependencies
- Views never navigate directly—always through Coordinator

### Modular Package Structure

Code organized in `Alfie/AlfieKit/` Swift Package with modules:
- **BFFGraphAPI**: Apollo-generated GraphQL types (auto-generated)
- **Core**: Services layer (API, auth, analytics, persistence)
- **Models**: Domain models and protocols
- **StyleGuide**: Design system (colors, typography, components)
- **Navigation**: Navigation framework protocols
- **SharedUI**: Localization resources
- **Mocks**: Test mocks
- **TestUtils**: Testing utilities

---

## Technology Stack

| Technology | Purpose | Version |
|------------|---------|---------|
| **Swift** | Programming language | 5.9+ |
| **SwiftUI** | UI framework | iOS 16+ |
| **Apollo iOS** | GraphQL client | 1.19.0 |
| **Firebase** | Analytics, Crashlytics, Remote Config | 11.11.0 |
| **Braze** | Marketing automation | 11.9.0 |
| **Nuke** | Image loading/caching | 12.8.0 |
| **Alicerce** | Utilities, logging | 0.18.0 |
| **XCTest** | Unit testing | Native |
| **Snapshot Testing** | UI testing | 1.18.3 |

**Build Tools**:
- Xcode 15+
- Swift Package Manager
- Fastlane (CI/CD)
- SwiftGen (code generation)
- SwiftLint (code quality)

---

## Key Conventions

### Code Style

- **SwiftLint enforced**: See `Alfie/.swiftlint.yml`
- **Trailing commas**: Mandatory
- **Function length**: Max 200 lines
- **Type length**: Max 400 lines
- **Naming**: CamelCase for types, camelCase for properties/functions
- **Fatal errors**: Use `queuedFatalError` instead of `fatalError`

### File Naming

- ViewModels: `<Feature>ViewModel.swift`
- Views: `<Feature>View.swift`
- Services: `<Feature>Service.swift` with `<Feature>ServiceProtocol`
- Dependency Containers: `<Feature>DependencyContainer.swift`

### Dependency Injection

```swift
// ✅ Good: ViewModel receives dependencies via DependencyContainer
final class FeatureViewModel {
    private let dependencies: FeatureDependencyContainer
    
    init(dependencies: FeatureDependencyContainer) {
        self.dependencies = dependencies
    }
}

// ❌ Bad: Never access ServiceProvider directly from ViewModel
```

### Localization

- **All user-facing strings** must use `L10n` generated enums
- Location: `AlfieKit/Sources/SharedUI/Resources/Localization/L10n.xcstrings`
- Naming: ReverseDomain + SnakeCase (e.g., `plp.error_view.title`)
- Generated code: Auto-generated by SwiftGen on build

```swift
// ✅ Good
Text(L10n.Home.title)
Text(L10n.Plp.NumberOfResults.message(count))

// ❌ Bad
Text("Home")
```

---

## Development Workflow

### Spec-Driven Development ⭐

**Always follow this process**:

1. **Write Spec First** → Create detailed spec in `Docs/Specs/Features/<Feature>.md`
2. **Break Into Tasks** → Extract smallest possible, independent tasks
3. **Implement One Task at a Time** → Follow the implementation checklist

**Spec Template**: See `Docs/Specs/TEMPLATE.md`

### GraphQL Workflow

1. Create query in `AlfieKit/Sources/BFFGraph/CodeGen/Queries/<Feature>/Queries.graphql`
2. Define fragments in `Fragments/` subdirectory
3. Extend schema in `CodeGen/Schema/schema-<feature>.graphqls`
4. Run codegen: `cd Alfie/scripts && ./run-apollo-codegen.sh`
5. Create converters in `Core/Services/BFFService/Converters/`
6. Implement service in `Core/Services/`

### Testing Strategy

- **Unit Tests**: ViewModels, services (use mocks from `Mocks` module)
- **Service Tests**: GraphQL converters, API integration
- **Localization Tests**: All keys exist, pluralization works
- **Snapshot Tests**: UI components match designs
- **Pattern**: Given-When-Then for test structure

---

## Important Constraints

### Security

- ⚠️ **Never commit unencrypted sensitive files**
- Use `git-secret` for sensitive data (requires GPG keys)
- Encrypted files: `GoogleService-Info.plist` (Debug/Release)

### Architecture Rules

❌ **NEVER**:
- Access `ServiceProvider` from ViewModels (use DependencyContainer)
- Hardcode user-facing strings (use `L10n`)
- Bypass Coordinator for navigation
- Edit auto-generated files (`BFFGraphAPI`, `L10n+Generated.swift`)
- Use `fatalError` (use `queuedFatalError`)
- Create custom UI without checking StyleGuide first

✅ **ALWAYS**:
- Create ViewModel protocol for mocking
- Use `@Published` for observable state
- Follow MVVM strictly
- Write tests for new features
- Update localization for all user-facing text
- Run SwiftLint before committing

### State Management

```swift
// Use appropriate state type
enum ViewState<Value, StateError: Error> {
    case loading
    case success(Value)
    case error(StateError)
}

enum PaginatedViewState<Value, StateError: Error> {
    case loadingFirstPage(Value)
    case loadingNextPage(Value)
    case success(Value)
    case error(StateError)
}
```

---

## Common Tasks

### Adding a New Feature

1. Create spec in `Docs/Specs/Features/<Feature>.md`
2. Define models in `Models/Models/<Feature>/`
3. Create service protocol in `Core/Services/<Feature>/`
4. Add GraphQL query (if needed) and run codegen
5. Implement service and register in `ServiceProvider`
6. Create ViewModel protocol in `Models/Features/`
7. Create ViewModel, DependencyContainer, and View
8. Add `Screen` case and update `ViewFactory`
9. Add Coordinator navigation methods
10. Add localization strings and build project
11. Write tests
12. Verify against spec acceptance criteria

### Adding Localization

1. Open `L10n.xcstrings` in Xcode
2. Add entry with ReverseDomain + SnakeCase key
3. Provide translations for all languages
4. Build project to generate `L10n+Generated.swift`
5. Use: `Text(L10n.Feature.key)`

### Adding GraphQL Query

1. Create `Queries.graphql` and fragments
2. Extend schema in `schema-<feature>.graphqls`
3. Run: `cd Alfie/scripts && ./run-apollo-codegen.sh`
4. Create converter extension
5. Add fetch method in `BFFClientService`

---

## Project Structure

```
Alfie-iOS/
├── AGENTS.md                          # This file
├── .github/
│   └── copilot-instructions.md        # Detailed Copilot guide
├── Docs/
│   ├── Specs/                         # Feature specifications
│   │   ├── README.md
│   │   ├── TEMPLATE.md
│   │   └── Features/
│   ├── NavigationScheme.jpeg
│   └── ProjectScheme.jpeg
├── Alfie/
│   ├── Alfie/                         # Main app target
│   │   ├── Views/                     # ViewModels, Views, Containers
│   │   ├── Navigation/                # Coordinator, Screen, Factory
│   │   └── Service/                   # ServiceProvider
│   ├── AlfieKit/                      # Swift Package
│   │   ├── Sources/
│   │   │   ├── BFFGraph/              # GraphQL
│   │   │   ├── Core/                  # Services
│   │   │   ├── Models/                # Domain models
│   │   │   ├── StyleGuide/            # Design system
│   │   │   └── ...
│   │   └── Tests/
│   └── scripts/                       # Build scripts
├── Gemfile                            # Ruby dependencies
└── Brewfile                           # macOS dependencies
```

---

## Quick Commands

```bash
# Install dependencies
brew bundle install

# Decrypt sensitive files (requires GPG keys)
git secret reveal

# Generate GraphQL code
cd Alfie/scripts && ./run-apollo-codegen.sh

# Generate localization code (or build project)
swift package --allow-writing-to-package-directory generate-code-for-resources

# Run tests
xcodebuild test -project Alfie/Alfie.xcodeproj -scheme Alfie \
  -destination 'platform=iOS Simulator,name=iPhone 15'

# Lint code
cd Alfie && swiftlint
```

---

## Resources

- **Detailed Instructions**: [`.github/copilot-instructions.md`](.github/copilot-instructions.md)
- **Feature Specs**: [`Docs/Specs/`](Docs/Specs/)
- **Spec Template**: [`Docs/Specs/TEMPLATE.md`](Docs/Specs/TEMPLATE.md)
- **Mock Server**: [Alfie-Mocks Repository](https://github.com/Mindera/Alfie-Mocks)
- **AGENTS.md Standard**: [https://agents.md/](https://agents.md/)

---

## AI Assistant Tips

When implementing features:

1. **Read the spec first** - Check `Docs/Specs/Features/` for requirements
2. **Follow patterns** - Look at existing features for consistency
3. **Check StyleGuide** - Reusable components in `AlfieKit/Sources/StyleGuide/`
4. **Use protocols** - All ViewModels need protocols for mocking
5. **Test your code** - Write unit tests, especially for ViewModels
6. **Localize strings** - Every user-facing text needs an `L10n` key
7. **Update spec status** - Mark as "Implemented" with PR link when done

---

**Note**: This is a living document. Update when architectural decisions change or new patterns emerge.
