# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

platform :ios do
  desc "Validate Tests"
  lane :validate_tests do

    sh("brew bundle install --file=../Brewfile")

    puts "ğŸ›  Running Tests..."
    run_tests(
      scheme: ENV['SCHEME']
    )
    puts "âœ… Tests Completed!"
  end

  desc "Deploy to TestFlight using Git tags"
  lane :beta do

    puts "ğŸ”‘ Fetching App Store Connect API Key..."
    app_store_connect_api_key
    puts "âœ… API Key Loaded!"

    puts "ğŸ” Running match..."
    match(type: "appstore")
    puts "âœ… Match Completed!"

    puts "#ï¸âƒ£ Fetching Build Number from latest tag..."
    last_build_number = sh("git tag -l '#*' --sort=-v:refname | head -n 1 | sed -e 's/#//g' | grep . || echo '0'").strip.to_i
    new_build_number = last_build_number + 1
    puts "âœ… Fetch Completed!"

    puts "ğŸ”¢ Last Build Number: #{last_build_number}"
    puts "ğŸš€ New Build Number: #{new_build_number}"

    puts "#ï¸âƒ£ Incremeting Build Number..."
    increment_build_number(build_number: new_build_number)
    puts "âœ… Build Number Increment Completed!"

    puts "ğŸ·ï¸ Updating tag..."
    new_tag = "'##{new_build_number}'"

    sh("git config user.name '#{ENV['GIT_USER_NAME']}'")
    sh("git config user.email '#{ENV['GIT_EMAIL']}'")
    sh("git tag #{new_tag}")
    sh("git push origin #{new_tag}")
    puts "âœ… Tag Update Completed!"

    puts "ğŸ›  Building app..."
    build_app(
      scheme: ENV['SCHEME'],
      export_options: { method: "app-store" }
    )
    puts "âœ… Build Completed!"

    puts "ğŸš€ Uploading to Testflight..."
    upload_to_testflight
    puts "âœ… Upload Completed!"
  end
end


